<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Scratch Full Color Converter</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            background: #222;
            color: #fff;
            padding: 20px;
        }
        .container {
            background: #333;
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
            border: 2px solid #4C97FF;
        }
        canvas {
            border: 1px solid #555;
            background: white;
            width: 360px;
            height: 360px;
            image-rendering: pixelated;
            margin: 20px 0;
        }
        button {
            background: #4C97FF;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
        }
        button:active {
            background: #3d85e6;
        }
        iframe {
            margin-top: 20px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Scratchカラー変換【1刻み】</h2>
        <p>0〜100の全数値を使用して最高画質で出力します</p>

        <input type="file" id="upload" accept="image/*"><br>

        <canvas id="canvas"></canvas><br>

        <button id="dlBtn" onclick="downloadTxt()">テキストリストを保存</button>
        <p id="status">画像を選択してください</p>

        <!-- ここにScratch埋め込み -->
        <iframe
            src="https://scratch.mit.edu/projects/1263294681/embed"
            allowtransparency="true"
            width="485"
            height="402"
            frameborder="0"
            scrolling="no"
            allowfullscreen>
        </iframe>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const status = document.getElementById('status');
        let finalData = [];

        document.getElementById('upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = 360;
                    canvas.height = 360;
                    ctx.fillStyle = "white";
                    ctx.fillRect(0, 0, 360, 360);

                    const scale = Math.min(360 / img.width, 360 / img.height);
                    ctx.drawImage(
                        img,
                        (360 - img.width * scale) / 2,
                        (360 - img.height * scale) / 2,
                        img.width * scale,
                        img.height * scale
                    );

                    const pixels = ctx.getImageData(0, 0, 360, 360).data;
                    finalData = [];
                    for (let i = 0; i < pixels.length; i += 4) {
                        const hsv = rgbToScratchHSV1(
                            pixels[i],
                            pixels[i + 1],
                            pixels[i + 2]
                        );
                        finalData.push(hsv.h, hsv.s, hsv.v);
                    }
                    status.innerText = "変換完了！ 388,800行の純粋なデータです。";
                };
                img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        });

        function rgbToScratchHSV1(r, g, b) {
            r /= 255;
            g /= 255;
            b /= 255;

            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const d = max - min;
            let h = 0;

            if (d !== 0) {
                if (max === r) h = (g - b) / d + (g < b ? 6 : 0);
                else if (max === g) h = (b - r) / d + 2;
                else h = (r - g) / d + 4;
            }

            return {
                h: Math.round((h / 6) * 100),
                s: Math.round((max === 0 ? 0 : d / max) * 100),
                v: Math.round(max * 100)
            };
        }

        function downloadTxt() {
            const blob = new Blob([finalData.join('\n')], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "ultimate_scratch_data.txt";
            a.click();
        }
    </script>
</body>
</html>
